<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - Usuário - Ápice</title>
  <link rel="stylesheet" href="/css/cadastro-comum.css" />
  <link rel="stylesheet" href="/css/validation.css" /> 
</head>

<body>
  <header>
    <%- include('../partials/menu') %>
    <h1 class="cadastro" style="display: block !important; visibility: visible !important; color: #160B5D !important; font-size: 34px !important; text-align: center !important; margin: 20px 0 !important; font-weight: 600 !important; font-family: 'Poppins', sans-serif !important;">Login</h1>
  </header>  

  <main class="cad-container">
    <section class="form-section">
      <p>Digite seus dados de acesso para entrar</p>
      
      <!-- Mostrar erros gerais se existirem -->
      <% if (typeof errors !== 'undefined' && errors && errors.length > 0) { %>
        <article class="general-error">
          <% errors.forEach(function(error) { %>
            <%= error.msg %><br>
          <% }) %>
        </article>
      <% } %>
      
      <!-- Mensagem de sucesso para cadastro -->
      <% if (typeof query !== 'undefined' && query.cadastro === 'sucesso') { %>
        <article class="success-message">
          Cadastro realizado com sucesso! Faça seu login para continuar.
        </article>
      <% } %>
      
      <form id="loginUsuarioForm" class="cad-form" method="POST" action="/login-usuario">
        <%
          function getFieldError(fieldName) {
            return (typeof errors !== 'undefined' && errors && errors.length) ? errors.find(function (it) { return it.param === fieldName; }) : null;
          }
          function getFieldValue(fieldName) {
            return (typeof form !== 'undefined' && form && form[fieldName]) ? form[fieldName] : '';
          }
        %>

        <% var emailError = getFieldError('email'); %>
        <input type="email" id="email" name="email" placeholder="Seu e-mail" 
               value="<%= getFieldValue('email') %>" 
               class="<%= emailError ? 'error' : '' %>" required />
        <span class="field-error"><%= emailError ? emailError.msg : '' %></span>

        <% var passwordError = getFieldError('password'); %>
        <div class="password-input-container">
          <input type="password" id="password" name="password" placeholder="Sua senha" 
                 class="<%= passwordError ? 'error' : '' %>" required />
          <button type="button" class="toggle-password" onclick="togglePassword('password')">
            <svg class="eye-icon eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 9C10.89 9 10 9.89 10 11C10 12.11 10.89 13 12 13C13.11 13 14 12.11 14 11C14 9.89 13.11 9 12 9ZM12 17C9.24 17 6.81 15.35 5.73 13C6.81 10.65 9.24 9 12 9C14.76 9 17.19 10.65 18.27 13C17.19 15.35 14.76 17 12 17ZM12 5C7 5 2.73 8.11 1 12C2.73 15.89 7 19 12 19C17 19 21.27 15.89 23 12C21.27 8.11 17 5 12 5Z" fill="currentColor"/>
            </svg>
            <svg class="eye-icon eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: none;">
              <path d="M12 7C14.76 7 17.19 8.65 18.27 11C17.83 11.82 17.23 12.53 16.5 13.11L18.83 15.44C20.5 14.1 21.8 12.47 22.38 10.5C21.27 7.11 17 4 12 4C10.5 4 9.07 4.3 7.76 4.84L9.65 6.73C10.41 7.27 11.17 7 12 7ZM2 4.27L4.28 6.55L4.74 7.01C3.08 8.3 1.78 10.02 1.22 12C2.73 15.89 7 19 12 19C13.55 19 15.03 18.7 16.38 18.16L16.8 18.58L19.73 21.51L21 20.24L3.27 2.51L2 4.27ZM7.53 9.8L9.08 11.35C9.03 11.56 9 11.78 9 12C9 13.66 10.34 15 12 15C12.22 15 12.44 14.97 12.65 14.92L14.2 16.47C13.53 16.8 12.79 17 12 17C9.24 17 6.81 15.35 5.73 13C6.06 12.31 6.53 11.67 7.08 11.13L7.53 9.8Z" fill="currentColor"/>
            </svg>
          </button>
        </div>
        <span class="field-error"><%= passwordError ? passwordError.msg : '' %></span>

        <div class="form-options">
          <a href="/recuperar-senha" class="forgot-password">Esqueci minha senha</a>
        </div>

        <button type="submit" class="submit-btn">Entrar</button>

        <div class="form-footer">
          <p>Não tem uma conta? <a href="/cadastro">Cadastre-se aqui</a></p>
          <p>É uma empresa? <a href="/login-empresa">Entrar como empresa</a></p>
        </div>
      </form>
    </section>
  </main>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/js/validation.js"></script>
  <script>
    // Função para mostrar/ocultar senha
    function togglePassword(fieldId) {
      const passwordField = document.getElementById(fieldId);
      const toggleButton = passwordField.parentElement.querySelector('.toggle-password');
      const eyeOpen = toggleButton.querySelector('.eye-open');
      const eyeClosed = toggleButton.querySelector('.eye-closed');
      
      if (passwordField.type === 'password') {
        passwordField.type = 'text';
        eyeOpen.style.display = 'none';
        eyeClosed.style.display = 'block';
      } else {
        passwordField.type = 'password';
        eyeOpen.style.display = 'block';
        eyeClosed.style.display = 'none';
      }
    }

    $(document).ready(function() {
      // Inicializar validação
      new FormValidator('loginUsuarioForm');
      
      // Adicionar comportamento específico do login
      $('#loginUsuarioForm').on('submit', function(e) {
        e.preventDefault();
        
        const email = $('#email').val().trim();
        const password = $('#password').val();
        
        // Validação básica
        let hasErrors = false;
        
        if (!email) {
          showFieldError('email', 'E-mail é obrigatório');
          hasErrors = true;
        } else if (!isValidEmail(email)) {
          showFieldError('email', 'Digite um e-mail válido');
          hasErrors = true;
        }
        
        if (!password) {
          showFieldError('password', 'Senha é obrigatória');
          hasErrors = true;
        }
        
        if (!hasErrors) {
          this.submit();
        }
      });
      
      // Função auxiliar para validar email
      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }
      
      // Função para mostrar erro em campo específico
      function showFieldError(fieldName, message) {
        const field = $(`#${fieldName}`);
        const errorSpan = field.next('.field-error');
        
        field.addClass('error');
        errorSpan.text(message);
      }
    });
  </script>
</body>
</html>